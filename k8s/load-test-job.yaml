apiVersion: batch/v1
kind: Job
metadata:
  name: load-test
  namespace: iot-analytics
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
        - name: load-tester
          image: alpine/curl
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting load test..."
              sleep 10
              for i in $(seq 1 180); do
                for j in $(seq 1 100); do
                  curl -s -X POST http://go-microservice.iot-analytics.svc.cluster.local/api/analytics/metrics \
                    -H "Content-Type: application/json" \
                    -d "{\"device_id\":\"device_$(($RANDOM % 100))\",\"cpu_usage\":$((RANDOM % 100)),\"memory_mb\":$((RANDOM % 2048)),\"rps\":$((800 + RANDOM % 400))}" &
                done
                sleep 1
                echo "Second $i: 100 requests sent"
              done
              
              echo "Load test completed"
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"
      restartPolicy: Never