apiVersion: batch/v1
kind: Job
metadata:
  name: load-test
  namespace: iot-analytics
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
        - name: load-tester
          image: alpine/curl
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "=== 500 RPS LOAD TEST (REAL FIRE) ===";
              URL="http://go-microservice/api/analytics/metrics";

              # Функция для запуска 500 запросов за секунду
              for sec in $(seq 1 300); do
                start_time=$(date +%s);

                # Запускаем 500 запросов ОДНОВРЕМЕННО без ожидания
                seq 1 500 | xargs -P 500 -I {} curl -s -X POST "$URL" \
                  -H "Content-Type: application/json" \
                  -d "{\"device_id\":\"device_$((RANDOM%1000))\",\"cpu_usage\":$((RANDOM%100)),\"rps\":500}" \
                  --connect-timeout 0.5 --max-time 1 -o /dev/null 2>&1 &

                # Считаем сколько времени прошло
                now=$(date +%s);
                elapsed=$((now - start_time));

                # Если успели меньше чем за секунду - ждем остаток
                if [ $elapsed -lt 1 ]; then
                  sleep $((1 - elapsed));
                fi

                echo "Second $sec: 500 requests FIRED (took ${elapsed}s)";
              done

              echo "=== TEST COMPLETE ===";
              wait;
          resources:
            limits:
              memory: "2Gi"
              cpu: "2000m"
      restartPolicy: Never